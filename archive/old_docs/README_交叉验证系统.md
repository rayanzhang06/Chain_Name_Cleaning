# 连锁名称置信度交叉验证系统 - 使用说明

## 📖 系统简介

本系统通过**规则交叉验证**方法，使用两套独立的评估规则对连锁名称置信度进行二次校验，显著提升评估准确性和可靠性。

### 核心特点

- ✅ **双评估器架构**：基于不同维度的两套独立评估规则
- ✅ **智能差异处理**：根据差异程度自动调整最终置信度
- ✅ **完整可追溯**：详细的验证报告和差异标记
- ✅ **人工审核支持**：明确标记需要人工复核的记录
- ✅ **断点续传**：支持中断后继续处理

---

## 🚀 快速开始

### 运行交叉验证

```bash
cd /Users/ruizhang/Desktop/Projects/连锁名称清洗关联
python3 run_cross_validation.py
```

### 预期输出

程序会生成以下文件：

1. **O2O连锁名称_交叉验证.xlsx** - 完整验证结果
2. **cross_validation_report.json** - 验证报告
3. **cross_validation_results.json** - 验证结果数据
4. **人工审核队列.xlsx** - 需要人工审核的记录

---

## 📊 输出文件说明

### 1. O2O连锁名称_交叉验证.xlsx

包含10列数据：

| 列名 | 说明 |
|------|------|
| 省份 | 原始数据 |
| 连锁名称 | 原始数据 |
| 置信度_原始评估 | 第一评估器的评分 |
| 置信度_模式评估 | 第二评估器的评分 |
| 评估差异 | 两次评估的绝对差异 |
| 验证状态 | CONSISTENT/ACCEPTABLE/DISCREPANT/CONFLICTING |
| 最终置信度 | 经过交叉验证后的最终置信度 |
| needs_review_flag | 内部标记 |
| 状态说明 | 中文状态描述 |
| 需要审核 | 是/否 |

### 2. 验证状态含义

| 状态 | 差异范围 | 处理策略 | 占比 |
|------|---------|---------|------|
| CONSISTENT | ≤0.05 | 简单平均 | 4.1% |
| ACCEPTABLE | 0.06-0.15 | 加权平均 | 4.8% |
| DISCREPANT | 0.16-0.25 | 保守策略 | 43.2% |
| CONFLICTING | >0.25 | 极保守策略 | 47.8% |

### 3. 人工审核队列.xlsx

包含1,671条需要人工审核的记录，按差异降序排列。

**审核优先级：**
- 差异 >0.40：最高优先级
- 差异 0.30-0.40：高优先级
- 差异 0.15-0.30：中优先级

---

## 🔧 系统架构

### 第一评估器：ChainNameEvaluator

**评估方法：** 关键词匹配

**核心规则：**
- 知名品牌数据库（一心堂、老百姓、益丰等）
- 高置信度关键词：连锁、集团、股份有限公司等
- 中等置信度关键词：大药房、医药、药店等
- 排除关键词：散店、代运营、测试等

**特点：** 简单高效，对知名品牌识别准确

### 第二评估器：PatternBasedEvaluator

**评估方法：** 模式匹配 + 特征分析

**核心规则：**
- 正则表达式模式匹配（完整公司名、区域性连锁等）
- 字符特征分析（长度、中文比例、括号等）
- 品牌词汇频率分析
- 结构完整性检查

**权重分配：**
- 模式匹配：40%
- 字符特征：30%
- 品牌词汇：20%
- 结构完整性：10%

**特点：** 更严格，对名称规范性要求高

### 交叉验证引擎：CrossValidationEngine

**核心功能：**
1. 协调两个评估器进行独立评估
2. 计算评估差异
3. 根据差异自动选择处理策略
4. 标记需要人工审核的记录
5. 生成详细验证报告

---

## 📈 验证效果

### 知名品牌验证

所有知名连锁品牌两次评估结果**高度一致**（差异仅0.02）：

| 品牌 | 原始评估 | 模式评估 | 差异 | 最终置信度 |
|------|---------|---------|------|-----------|
| 一心堂 | 0.98 | 0.96 | 0.02 | 0.97 |
| 老百姓大药房 | 0.98 | 0.96 | 0.02 | 0.97 |
| 益丰 | 0.98 | 0.96 | 0.02 | 0.97 |
| 海王星辰 | 0.97 | 0.95 | 0.02 | 0.96 |
| 国大药房 | 0.97 | 0.95 | 0.02 | 0.96 |

### 总体验证统计

- **总评估数量：** 1,835个唯一名称
- **平均差异：** 0.243
- **高度一致：** 76条 (4.1%)
- **需要人工审核：** 1,671条 (91.1%)

---

## 💡 使用建议

### 1. 直接使用结果

对于 **高度一致** 的记录（差异≤0.05），可直接使用最终置信度，无需人工审核。

**适用场景：**
- 知名品牌（一心堂、老百姓、益丰等）
- 规范的公司全名
- 明确的连锁标识

### 2. 参考使用

对于 **可接受差异** 的记录（0.06-0.15），最终置信度是加权平均，可作为参考。

**建议：**
- 重点关注品牌名称
- 检查是否有特殊情况

### 3. 人工审核

对于 **明显差异** 和 **严重冲突** 的记录（>0.15），需要人工复核。

**审核方法：**
1. 打开《人工审核队列.xlsx》
2. 按优先级从高到低审核
3. 对比两次评估的差异原因
4. 通过在线搜索验证企业信息
5. 确定最终置信度

---

## 🔄 重新运行

### 清除进度重新计算

```bash
rm cross_validation_progress.json
python3 run_cross_validation.py
```

### 断点续传

如果程序中断，再次运行会自动从上次进度继续：

```bash
python3 run_cross_validation.py
```

---

## 🛠️ 自定义配置

### 调整差异阈值

编辑 `cross_validation_engine.py` 中的 `_default_config()` 方法：

```python
def _default_config(self):
    return {
        'thresholds': {
            'consistent': 0.05,    # 可调整
            'acceptable': 0.15,    # 可调整
            'discrepant': 0.25,    # 可调整
        },
        'manual_review_threshold': 0.15,  # 可调整
    }
```

### 添加知名品牌

编辑 `smart_evaluate.py` 和 `pattern_based_evaluator.py` 中的 `famous_chains` 字典：

```python
self.famous_chains = {
    '新品牌名称': 0.95,
    # ...
}
```

---

## 📚 扩展阅读

### 添加第三套评估规则

系统设计支持添加更多评估器：

```python
from third_evaluator import ThirdEvaluator

evaluator3 = ThirdEvaluator()
# 使用多评估器框架
```

### 配置文件驱动

（未来版本）支持通过YAML配置文件驱动所有参数。

---

## 📞 技术支持

如有问题或建议，请检查：

1. 确认Python版本 >= 3.7
2. 确认已安装所需库：pandas, openpyxl
3. 查看验证报告了解详细统计信息
4. 检查人工审核队列中的具体案例

---

## 📝 更新日志

### v1.0 (2026-01-05)

- ✅ 实现双评估器交叉验证系统
- ✅ 支持自动差异处理策略
- ✅ 生成完整验证报告
- ✅ 导出人工审核队列
- ✅ 支持断点续传
- ✅ 知名品牌识别优化

---

**最后更新：** 2026-01-05
**版本：** v1.0
**作者：** Claude Code
